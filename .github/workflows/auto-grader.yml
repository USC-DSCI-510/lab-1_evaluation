name: Master Autograder Workflow

on: 
    pull_request:
        branches:
            - main
    workflow_dispatch:

jobs:
    auto_grade:
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            CLASSROOM_ID: ${{ vars.CLASSROOM_ID }}
            ASSIGNMENT_ID: ${{ vars.ASSIGNMENT_ID }}
        steps:
            - name: Install GitHub Classroom CLI  
              run: gh extension install github/gh-classroom

            - name: GitHub CLI authentication  
              run: gh auth status

            - name: Clone Evaluation Repo
              run: gh repo clone USC-DSCI-510/lab-1_evaluation -- -b 2-auto-grading-scripts-workflows

            # - name: Clone Assignments
            #   run: gh classroom clone student-repos -a $ASSIGNMENT_ID

            - name: Clone Test Assignments
              run: gh repo clone USC-DSCI-510/lab-1-akshaya999
            
            # - name: Set Git Configuration
            #   run: |
            #     git config --global user.name 'github-actions[bot]'
            #     git config --global user.email 'github-actions[bot]@users.noreply.github.com'

            - name: Copy Grading Files
              run: |
                  cd lab-1-akshaya999

                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git config user.name "github-actions[bot]"

                  git checkout -b auto-grader-test

                  cp -r ../lab-1_evaluation/.github/classroom/autograding.json ./.github/classroom/autograding.json
                  cp -r ../lab-1_evaluation/.github/workflows/classroom.yml ./.github/workflows/classroom.yml
                  cp -r ../lab-1_evaluation/test_functions.py .

                  git add .
                  git commit -m "Add testing and grading files"
                  git push origin auto-grader-test
                  
                  cd ..

            - name: Cleanup Cloned Repositories
              run: |
                rm -rf */
            